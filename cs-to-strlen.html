<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="tw" xml:lang="tw">
<head>
<!-- 2023-06-12 一 09:39 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>autlisp Big5/ UTF-8 字碼 中文字字元數的計算</title>
<meta name="author" content="各申機械設計工作室" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
</style>
<link rel="stylesheet" type="text/css" href="https://gongzhitaao.org/orgcss/org.css"/>
<meta name='description'  content='autlisp Big5/ UTF-8 字碼 中文字字元數的計算'/>
</head>
<body>
<div id="content" class="content">
<h1 class="title">autlisp Big5/ UTF-8 字碼 中文字字元數的計算</h1>
<div id="outline-container-org259426d" class="outline-2">
<h2 id="org259426d"><span class="section-number-2">1.</span> 前言</h2>
<div class="outline-text-2" id="text-1">
<p>
在 Autocad 2022 之前的 autolisp 函數 (strlen "字串") 它會返回字串的字元數，但是有一個特殊現象是它會把中文字的字元數以 1 個中文字元返回字元數為 2。
然而在 Autocad 2022 以後，和 BricsCAD 相同，其設定為一個中文字為一個字元。這也許是 Autocad 2022 年之後正式支援 UTF-8 字碼輸出有關。想當年編寫 autolisp 要顯示中文時還特定將檔案文字編碼指定成 Big5 碼，以避免載入 Autocad 時產生亂碼。我們也一直質疑為什麼 autocad 不支援 UTF-8 的檔案。
</p>
<p class="verse">
;;; autocad 2022 之前<br />
指令：(strlen "中文")<br />
4<br />
<br />
;;; autocad 2022 後及 BricsCAD<br />
指令：(strlen "中文")<br />
2<br />
</p>

<p>
現在朋友遇到了一個問題，那就是他的客戶有許多程式是需要使用 (stelen &#x2026;) 來計算字串的字元數的，但是在 Autocad 2022 後，其 autolisp 程式在應用上會造成與之前版本的工具有所偏差。以致於無法引入 Autocad 2022 或是 BricsCAD 等工具。
以下程式可以先解燃眉之急，但是以長遠來看，未來還是要檢示一下程式中是否要修正的地方。
</p>
</div>
</div>

<div id="outline-container-org20daac5" class="outline-2">
<h2 id="org20daac5"><span class="section-number-2">2.</span> 原始碼</h2>
<div class="outline-text-2" id="text-2">
<p>
這個程式是以中文字與英文字及符號為區分字元數。希望以 (cs-to-strlen "字串") 取代僅以 (strlen "字串") 去判斷返回的字元數。然而這個程式無法如 (strlen &#x2026;) 接受不同型式的引數；如 (strlen)、(strlen "字串1") 或 (strlen "字串1" "字串2" "字串3")等等。
也就是說它只能使用一個引數。例子如下
</p>
<p class="verse">
;;; autocad / bricscad<br />
指令：(cs-to-strlen "中文12345")<br />
9<br />
指令：(cs-to-strlen "中文 abcd")<br />
9<br />
指令：(cs-to-strlen "123中文 abcd")<br />
12<br />
</p>
<p>
如果以 (cs-to-strlen &#x2026;) 取代 (strlen &#x2026;) 修改程式，並且注意引數的型式，它可以支援以前的程式，無論 CAD 軟體是否有支援 UTF-8 字碼。(cs-to-strlen "字串")可以返回舊有程式中計算字串 1 中文字 2 字元數的數值。
現階段已經在 AutoCAD 2017/ AutoCAD 2022/ AutoCAD 2024 及 BricsCAD 2023 測試可行。
</p>
</div>
<div id="outline-container-org4d1bfad" class="outline-3">
<h3 id="org4d1bfad"><span class="section-number-3">2.1.</span> cs-to-strlen.lsp</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #fa8072;">;;;; </span><span style="color: #ff7f24; font-style: italic;">-*- encoding:big5 -*-</span>
<span style="color: #fa8072;">;; </span><span style="color: #ff7f24; font-style: italic;">autocad 2022 (Big5/ UTF-8) &#20013;&#25991;&#23383;&#23383;&#20803;&#25976;&#30340;&#35336;&#31639;</span>

<span style="color: #fa8072;">;;; </span><span style="color: #ff7f24; font-style: italic;">&#37325;&#36617;&#21407;&#22987;&#30908;</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #00fa9a; font-weight: bold;">reload-file</span> (filename)
  (load filename)
  (print (strcat filename <span style="color: #ffc1c1;">" &#24050;&#35712;&#21462;!"</span>))
  (princ))

(<span style="color: #00ffff;">defun</span> <span style="color: #00fa9a; font-weight: bold;">c:rrr-cs-to-strlen</span> ()
  (reload-file <span style="color: #ffc1c1;">"cs-to-strlen.lsp"</span>))

(<span style="color: #00ffff;">defun</span> <span style="color: #00fa9a; font-weight: bold;">cs-to-strlen</span> (str / num fig1 sum)
  <span style="color: #fa8072;">;; </span><span style="color: #ff7f24; font-style: italic;">Big5 &#20013;&#23383;&#23383;&#20301;&#35336;&#31639;</span>
  (<span style="color: #00ffff;">if</span> (&gt; (strlen <span style="color: #ffc1c1;">"&#20013;"</span>) 1)
      (<span style="color: #00ffff;">progn</span>
        <span style="color: #fa8072;">;; </span><span style="color: #ff7f24; font-style: italic;">(print "&gt;1")</span>
        (strlen str))
      (<span style="color: #00ffff;">progn</span>
        (setq num (strlen str)
              fing1 0
              sum 0)
        <span style="color: #fa8072;">;; </span><span style="color: #ff7f24; font-style: italic;">(print num)</span>
        (<span style="color: #00ffff;">while</span> (&lt; 0 num)
               (<span style="color: #00ffff;">if</span> (&gt; (ascii (substr str 1 1)) 128)
                   (setq sum (+ sum 2))
                   (setq sum (1+ sum)))
               (setq str (substr str 2))
               (setq num (1- num)))
        sum)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf3f4fae" class="outline-3">
<h3 id="orgf3f4fae"><span class="section-number-3">2.2.</span> 版權宣告/ Copyright notice</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Copyright (C) 2023 Each Application Mechanical Design Studio
</p>


<p>
Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
</p>

<p>
The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
</p>

<p>
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
</p>
</div>
</div>
</div>

<div id="outline-container-org6996a1f" class="outline-2">
<h2 id="org6996a1f"><span class="section-number-2">3.</span> <a href="https://sites.google.com/view/each-application/homepage">各申機械設計工作室/ Each Application Mechanical Design Studio</a></h2>
</div>
</div>
</body>
</html>
